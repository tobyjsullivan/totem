<!DOCTYPE html>
<head>
  <script>
    
  </script>
  <style>
    .display {
      border: 1px solid #000;
    }
  </style>
<body>
  <p>PDF: <input type="file" id="pdf-picker"><button id="pdf-upload-button">Upload PDF</button></p>
  <div id="container"></div>
  <p><input type="file" id="file-picker" accept="image/png, image/jpeg"><button id="upload-button">Upload Image</button></p>
  <p><textarea id="output" cols="60" rows="30"></textarea></p>
<script>
class CanvasState {
  constructor() {
    this.dragging = false;
    this.rectangles = [];
  }

  isDragging() {
    return this.dragging;
  }

  getDragStart() {
    return this.drag_start;
  }

  getDragEnd() {
    return this.drag_end;
  }

  setDragEnd(x, y) {
    this.drag_end = {x, y};
  }

  startDragging(x, y) {
    this.dragging = true;
    this.drag_start = {x, y};
    this.drag_end = this.drag_start;
  }

  stopDragging() {
    this.dragging = false;
    this.drag_start = undefined;
    this.drag_end = undefined;
  }

  addRect(x, y, width, height) {
    console.log('addRect %o, %o, %o, %o', x, y, width, height);
    this.rectangles.push({x, y, width, height});
  }

  getRectangles() {
    return this.rectangles;
  }
}

class Canvas {
  constructor($canvas, img) {
    this.$canvas = $canvas;
    this.state = new CanvasState();
    this.img = img;

    $canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
    $canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
    $canvas.addEventListener('mouseup', this.handleMouseUp.bind(this));

    const ctx = $canvas.getContext('2d');
    setInterval(() => this.draw(ctx), 30);
  }

  draw(ctx) {
    ctx.clearRect(0, 0, this.$canvas.width, this.$canvas.height);
    ctx.drawImage(this.img, 0, 0);

    const rects = this.state.getRectangles();
    ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
    for (let idx in rects) {
      const rect = rects[idx];
      ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
    }

    if(this.state.isDragging()) {
      ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
      const start = this.state.getDragStart();
      const end = this.state.getDragEnd();
      ctx.fillRect(start.x, start.y, end.x - start.x, end.y - start.y);
    }

  }

  handleMouseDown(evt) {
    const pos = this.calcMousePos(evt);
    this.state.startDragging(pos.x, pos.y);
  }

  handleMouseMove(evt) {
    const pos = this.calcMousePos(evt);
    this.state.setDragEnd(pos.x, pos.y);
  }

  handleMouseUp(evt) {
    const start = this.state.getDragStart();
    const end = this.calcMousePos(evt);
    this.state.stopDragging();
    this.state.addRect(start.x, start.y, end.x - start.x, end.y - start.y);
    this.fireChanged();
  }

  fireChanged() {
    if (this.onchange) {
      const rects = this.state.getRectangles();
      this.onchange(rects);
    }
  }

  calcMousePos(evt) {
    const rect = this.$canvas.getBoundingClientRect();
    return {
      x: evt.clientX - rect.left,
      y: evt.clientY - rect.top
    };
  }
}

function handle_file_picked() {
  const $file_picker = document.getElementById('file-picker');
  const file = $file_picker.files[0];
  console.log('File: %o', file);

  const pFileLoaded = new Promise(function(resolve, reject) {
    const fr = new FileReader();
    fr.onload = resolve;
    fr.readAsDataURL(file);
  });

  const pImageLoaded = pFileLoaded.then(function(e) {
    const image = e.target.result;

    const img = new Image();
    img.src = image;
    return new Promise(function(resolve, reject) {
      img.addEventListener('load', function() {
        resolve(img);
      });
    });
  });

  pImageLoaded.then(function(img) {
    const width = img.naturalWidth;
    const height = img.naturalHeight;

    const $canvas = document.createElement('canvas');
    $canvas.setAttribute('width', width);
    $canvas.setAttribute('height', height);

    const canvas = new Canvas($canvas, img);
    canvas.onchange = (rects) => handle_img_changed(file.name, rects);

    const $container = document.getElementById('container');
    $container.appendChild($canvas);
  });
}

const output = {};
const $output = document.getElementById('output');

function handle_img_changed(filename, rects) {
  output[filename] = rects;
  $output.innerHTML = JSON.stringify(output, null, 2);
}

const $upload_button = document.getElementById('upload-button');
$upload_button.onclick=handle_file_picked;

const $pdf_upload_button = document.getElementById('pdf-upload-button');
$pdf_upload_button.onclick = function() {
  const $pdf_picker = document.getElementById('pdf-picker');
  const formData = new FormData();
  formData.append('hello', 'world');
  formData.append('file', $pdf_picker.files[0]);
  
  const req = new XMLHttpRequest();
  req.open('POST', 'http://localhost:8080/documents');
  req.send(formData);
}

</script>
